<import src="../../template/freeze.wxml" />
<freeze-time is-to-open='{{isToOpen}}'>
</freeze-time>
<template is="freeze" data='{{isFreezing}}' />
<import src="../../template/price.wxml" />
<wxs module="filters" src="../../utils/math.wxs"></wxs>
<import src="./promotionInfo.wxml" />
<view wx:if='{{trolley.length}}' style="height: 100%;">
  <scroll-view scroll-y style="height:80%;" bindscrolltoupper='upper' bindscrolltolower="lower" scroll-into-view="{{toView}}" scroll-top="{{scrollTop}}" bindscroll="scroll">
    <view wx:for='{{trolley}}' wx:for-index="groupIndex" wx:key='unique' wx:for-item="trollyGroup" style='margin-top:15rpx;margin-bottom:0rpx;'>
      <view wx:if="{{trollyGroup.combinationFlag == '0'}}">

        <view wx:for='{{trollyGroup.items}}' wx:key='unique'>
          <view style='display: flex; flex-direction: column; '>
            <view class='center padding trolley-container regular bgc' style="padding-left: 0; padding-right:16rpx; padding-bottom: 0;">
              <view class='center-center'>
                <radio catch:tap='radioClick' class="radio" data-index='{{groupIndex}}' data-groupid='{{trollyGroup.groupId}}' value="{{groupIndex}}" checked="{{trollyGroup.checked}}" wx:if='{{trollyGroup.putShelvesFlg && trollyGroup.activeFlg && !item.isfree&&(item.inventoryCount!==0)}}'
                  color='{{trollyGroup.checked?"#EE711F":"#D1D1D2"}}' style='transform:scale(.8);'>
                </radio>
                <text wx:elif='{{trollyGroup.putShelvesFlg && item.isfree&&(item.inventoryCount!==0)}}' class='radio trolley-invalid regular'></text>
                <text wx:else class='radio trolley-invalid regular' style='width:50rpx; font-size:24rpx;'>失效</text>
              </view>
              <view style="position: relative;"  bind:tap='turnPage' data-itemid='{{item.itemId}}' data-categorycode='{{item.itemCategoryCode}}'>
                <image src='{{item.itemImageAddress1?(item.itemImageAddress1+"?x-oss-process=style/180w"):defImg}}' class='goods-img ' mode='aspectFit'>
                </image>
                <view wx:if='{{item.inventoryCount===0}}' class='trolley-soldout regular center-center'>售罄</view>
                <view wx:elif='{{!trollyGroup.putShelvesFlg}}' class='trolley-soldout regular center-center'>已下架</view>
              </view>
              <view class='column trolley-right '>
                <view style='display:flex; flex-direction: column; width:100%;' bind:tap='turnPage' data-itemid='{{item.itemId}}' data-categorycode='{{item.itemCategoryCode}}'>
                  <view style='display:flex;  width:100%;'>
                    <text class='promotion-1' style='display:inline-block; margin-left:0;' wx:if='{{item.isfree}}'>赠品</text>
                    <text class='trolley-name {{trollyGroup.putShelvesFlg?"":"trolley-opacity"}}'>{{item.itemName}}</text>
                    <text></text>
                  </view>

                  <view class='center trolley-middle'>
                    <text class='trolley-spec {{trollyGroup.putShelvesFlg?"":"trolley-opacity"}}'>规格：{{item.itemSpecification}}</text>
                    <view catch:tap='promptDel' data-groupid='{{trollyGroup.groupId}}' data-index='{{groupIndex}}' class='center-center' style="width: 70rpx;height: 80rpx;">
                      <image src='./img/del.png' class='del {{trollyGroup.putShelvesFlg?"":""}}' wx:if="{{!item.isfree}}"></image>
                    </view>
                  </view>
                </view>
                <view class='center trolley-bottom'>

                  <text wx:if='{{trollyGroup.putShelvesFlg && item.inventoryCount!==0}}' class='dollar medium trolley-price'><template is="price" data="{{price:item.price}}" />
                  <text class='regular sales-unit' style='color:#999999;'>/{{item.saleUnit}}</text>
                  </text>
                  <text wx:else class='regular trolley-not-buy'>宝贝已{{item.inventoryCount===0?'售罄':'下架'}}不能购买</text>
                  <view wx:if='{{trollyGroup.putShelvesFlg && trollyGroup.activeFlg&&!item.isfree&&(item.inventoryCount!==0)}}' class='center' style='align-items:center;' catch:tap='preventBubble'>
                    <image src='./img/reduce2.png' class='plus-minus minus-padding center-center' style='opacity:{{item.quantity===1?0.5:1}};' catch:tap='plusMinus' data-index='{{groupIndex}}' data-itemid='{{item.itemId}}' data-type='minus' data-enabled='{{trollyGroup.putShelvesFlg && trollyGroup.activeFlg&&(item.inventoryCount!==0)}}'></image>
                    <input type="number" maxlength='5' value='{{item.quantity}}' class='num-input plus-minus center-center btn-txt-1' bindinput='bindinput' bindblur='bindblur' style="font-size: 26rpx;" data-index='{{groupIndex}}' data-itemid='{{item.itemId}}' data-enabled='{{trollyGroup.putShelvesFlg && trollyGroup.activeFlg}}'
                    />
                    <image src='./img/add2.png' class='plus-minus plus-padding center-center' catch:tap='plusMinus' data-index='{{groupIndex}}' data-itemid='{{item.itemId}}' data-enabled='{{trollyGroup.putShelvesFlg && trollyGroup.activeFlg&&(item.inventoryCount!==0)}}'></image>
                  </view>
                </view>
              </view>
            </view>

            <template is="promotionInfo" data="{{trollyGroup}}" wx:if="{{trollyGroup.cartCombinationPromotions.length >0}}" />

            <!-- && item.isfree -->
            <view class='promotion' style='font-size:24rpx; padding-bottom:0rpx;margin-bottom:0;' wx:if="{{trollyGroup.cartCombinationPromotions[0].promotionType == '1'}}">
              <view wx:if='{{trollyGroup.cartCombinationPromotions[0].giftItems.length>0}}'>
                <view class='center padding trolley-container regular bgc' style="padding-left: 40rpx; ">
                  <view style="position: relative;"  bind:tap='turnPage' data-itemid='{{trollyGroup.cartCombinationPromotions[0].giftItems[0].giftItemId}}'>
                    <image src='{{trollyGroup.cartCombinationPromotions[0].giftItems[0].itemImageAddress1?(trollyGroup.cartCombinationPromotions[0].giftItems[0].itemImageAddress1+"?x-oss-process=style/180w"):defImg}}' class='goods-img ' mode='aspectFit'>
                    </image>
                  </view>
                  <view class='column trolley-right '>
                    <view style='display:flex; flex-direction: column; width:100%;'  bind:tap='turnPage' data-itemid='{{trollyGroup.cartCombinationPromotions[0].giftItems[0].giftItemId}}'>
                      <view style='display:flex;  width:100%;'>
                        <text class='promotion-1' style="display:inline-block; margin-left:0;">赠品</text>
                        <text class='trolley-name' style='width:380rpx;  margin-left:8rpx;'>{{trollyGroup.cartCombinationPromotions[0].giftItems[0].giftItemName}}</text>
                      </view>

                      <view class='center trolley-middle'>
                        <text class='trolley-spec '>规格：{{trollyGroup.cartCombinationPromotions[0].giftItems[0].itemSpecification}}</text>

                      </view>
                    </view>
                    <view class='center trolley-bottom'>
                      <view style='width:auto; margin-top:10rpx;'>
                        <text class='dollar medium trolley-price' style='margin-top:20rpx;'><template is="price" data="{{price:'0'}}" /></text>
                        <text class='dollar medium trolley-price' style='text-decoration:line-through; color:#999999;' wx:if="{{trollyGroup.cartCombinationPromotions[0].giftItems[0].price}}">{{trollyGroup.cartCombinationPromotions[0].giftItems[0].price}}<text class='sales-unit'>/个</text></text>
                      </view>
                      <text class='medium trolley-price' style='color:#999999; margin: 20rpx;'>x{{trollyGroup.cartCombinationPromotions[0].giftItems[0].quantity}}</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

    </view>
  </scroll-view>

  <view class='trolley-total bgc regular '>
    <view class='center trolley-calc padding' style='visibility:{{disableBuy?"visible":"hidden"}};'>
      <block wx:if='{{selectedLen}}'>
        <text>还差¥{{remaining}}可生成订单</text>
        <view class='center' style="align-items: center;">
          <text catch:tap='addOn'>去凑单</text>
          <image src='./img/arrow.png' class='trolley-arrow'></image>
        </view>
      </block>
      <text wx:else>订单最低起定价:¥500</text>
    </view>
    <view wx:if='{{cartCombinationPromotions.len}}' class='center trolley-calc padding' style='background:rgb(251,241,222	)'>
      <block>
        <text></text>
        <view catch:tap='toPromotionActivity' class='center' style="align-items: center;">
          <text>可享{{cartCombinationPromotions.len}}个优惠，可送{{cartCombinationPromotions.gifts}}个赠品</text>
          <image src='./img/arrow.png' class='trolley-arrow'></image>
        </view>
      </block>
    </view>
    <view class='center trolley-confirm bottom-box-shadow'>
      <radio style='transform:scale(.74);' value="{{item.name}}" checked='{{checkAll}}' catch:tap='selectAll' color='{{checkAll?"#EE711F":"#D1D1D2"}}'>
        <view style="font-size: 36rpx; padding-left:0rpx;">全选</view>
      </radio>
      <view style='display: flex; flex-direction: column;'>
        <view class='center' style='align-items:center;'>
          <text>合计:</text>

          <text class='dollar trolley-num medium'><template is="price" data="{{price:currentMoney,fontSize:28}}" /></text>
        </view>
        <view style='display: flex; flex-direction: row; font-size:24rpx;' wx:if="{{totalDiscountMoney!=0}}">
          <view>金额</view>
          <view>¥{{filters.toFix(overallMoney)}}</view>
          <view>已省</view>
          <view>¥{{totalDiscountMoney}}</view>
        </view>
      </view>


      <button class='trolley-btn center-center {{disableBuy?"":"enable"}}' catch:tap='confirmOrder' hover-class='btn-hover'>确认订单({{selectedLen}})</button>
    </view>
  </view>
</view>
<view wx:elif="{{!dataLoaded}}"></view>
<view wx:else class='regular trolley-empty center-center'>
  <view class='column'>
    <image src='/images/ic_cart_def@2x.png'></image>
    <text>您的购物车还没有商品喔</text>
    <button catch:tap='gotoSort'>去商城逛逛</button>
  </view>
</view>
<!-- <cover-view style='position:relative;z-index:10;'> -->
<view wx:if='{{isSelecting}}' style='position: fixed; height: 100%; width:100%;top:0; left: 0; z-index:10;'>
  <view wx:if='{{isSelecting}}' class='mask' style='background-color: #000;opacity:.3;' catch:tap='closePopup'></view>
  <view class='select-goods bgc ' style='bottom:0rpx;z-index: 21;'>
    <view class='center padding' style='justify-content:space-between;'>
      <view style='font-size:32rpx; margin-left:0rpx;'>切换促销</view>
      <image src='../../images/close.png' class='close-popup' style='margin-right:4rpx;' catch:tap='closePopup'></image>
    </view>
    <view class='line'></view>
    <view class='padding' style='padding:18rpx 0rpx;'>
      <scroll-view scroll-y style="height: 674rpx;">
        <view wx:for='{{promotionOptions}}' wx:key='unique' style='padding:18rpx 18rpx; '>
          <radio style='transform:scale(.8); margin-left: -80rpx;' value="{{index}}" checked='{{item.checked}}' data-index='{{index}}' catch:tap='selectPromotion' color='{{item.checked?"#EE711F":"#D1D1D2"}}'>
            <view style="width:800rpx;font-size: 36rpx; padding-left:10rpx;word-wrap:break-word;">{{item.promotionName}}</view>
          </radio>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
<!-- </cover-view> -->